<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Songify Studio v3</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { background: #050505; color: white; font-family: 'Inter', sans-serif; }
        .glass { background: rgba(255, 255, 255, 0.03); backdrop-filter: blur(10px); border: 1px solid rgba(255,255,255,0.1); }
        .neon-btn { background: #2563eb; box-shadow: 0 0 15px rgba(37,99,235,0.4); }
        input[type='range'] { accent-color: #2563eb; }
    </style>
</head>
<body class="p-6 flex flex-col items-center">
    <div class="w-full max-w-xl space-y-6">
        <header class="text-center py-10">
            <h1 class="text-4xl font-black text-blue-500 italic tracking-tighter">SONGIFY PRO</h1>
            <p class="text-gray-500 text-sm">3 Free Generations Daily</p>
        </header>

        <div id="box1" class="glass p-8 rounded-3xl">
            <input id="prompt" type="text" placeholder="Mood or Topic..." class="w-full bg-black/40 p-4 rounded-xl mb-4 border border-white/10 outline-none focus:border-blue-500">
            <button onclick="getLyrics()" id="btn1" class="w-full py-4 rounded-xl font-bold neon-btn">Write Lyrics âœ¨</button>
        </div>

        <div id="box2" class="hidden glass p-8 rounded-3xl animate-pulse-slow">
            <textarea id="lyricBox" class="w-full h-64 bg-black/40 p-4 rounded-xl border border-blue-500/50 mb-4 text-sm leading-relaxed"></textarea>
            <div class="flex gap-2">
                <button onclick="location.reload()" class="flex-1 bg-gray-800 py-4 rounded-xl font-bold">Discard</button>
                <button onclick="startMusic()" class="flex-1 neon-btn py-4 rounded-xl font-bold">Generate Music ðŸŽµ</button>
            </div>
        </div>

        <div id="box3" class="hidden glass p-8 rounded-3xl text-center">
            <div id="loader" class="mb-4">
                <div class="animate-spin rounded-full h-10 w-10 border-b-2 border-blue-500 mx-auto"></div>
                <p id="stext" class="mt-4 text-blue-400 font-bold">Recording Session...</p>
            </div>
            <div id="player" class="hidden space-y-4">
                <div class="bg-blue-600/10 p-6 rounded-2xl border border-blue-500/20">
                    <button onclick="toggle()" class="w-16 h-16 bg-blue-600 rounded-full mx-auto flex items-center justify-center">
                        <svg id="pIcon" class="w-8 h-8 fill-white" viewBox="0 0 24 24"><path d="M8 5v14l11-7z"/></svg>
                    </button>
                    <input type="range" id="seek" value="0" class="w-full mt-6">
                    <button onclick="download()" class="w-full mt-4 py-2 text-xs font-bold text-gray-400 uppercase">Download MP3</button>
                </div>
            </div>
        </div>

        <div id="history" class="space-y-2"></div>
    </div>

    <audio id="aud"></audio>

    <script>
        let jid = ""; let aud = document.getElementById('aud');
        async function getLyrics() {
            const p = document.getElementById('prompt').value;
            if(!p) return;
            document.getElementById('btn1').innerText = "AI is thinking...";
            const fd = new FormData(); fd.append('prompt', p);
            const r = await fetch('/get-lyrics', {method:'POST', body:fd});
            const d = await r.json();
            if(d.job_id === "error") return alert(d.lyrics);
            jid = d.job_id;
            document.getElementById('lyricBox').value = d.lyrics;
            document.getElementById('box1').classList.add('hidden');
            document.getElementById('box2').classList.remove('hidden');
        }

        async function startMusic() {
            const l = document.getElementById('lyricBox').value;
            const t = document.getElementById('prompt').value;
            document.getElementById('box2').classList.add('hidden');
            document.getElementById('box3').classList.remove('hidden');
            const fd = new FormData(); fd.append('job_id', jid); fd.append('final_lyrics', l); fd.append('topic', t);
            await fetch('/confirm-lyrics', {method:'POST', body:fd});

            const poll = setInterval(async () => {
                const r = await fetch('/status/'+jid);
                const d = await r.json();
                document.getElementById('stext').innerText = d.status;
                if(d.status === "Success") {
                    clearInterval(poll);
                    setupPlayer(d.audio, t);
                }
            }, 5000);
        }

        function setupPlayer(url, title) {
            document.getElementById('loader').classList.add('hidden');
            document.getElementById('player').classList.remove('hidden');
            aud.src = url;
            saveHistory(title, url);
        }

        function toggle() {
            const icon = document.getElementById('pIcon');
            if(aud.paused) { aud.play(); icon.innerHTML = '<path d="M6 19h4V5H6v14zm8-14v14h4V5h-4z"/>'; }
            else { aud.pause(); icon.innerHTML = '<path d="M8 5v14l11-7z"/>'; }
        }

        async function download() {
            const r = await fetch(aud.src);
            const b = await r.blob();
            const a = document.createElement('a'); a.href = URL.createObjectURL(b); a.download = 'song.mp3'; a.click();
        }

        function saveHistory(t, u) {
            let h = JSON.parse(localStorage.getItem('songs') || '[]');
            h.unshift({t, u});
            localStorage.setItem('songs', JSON.stringify(h.slice(0, 5)));
            renderHistory();
        }

        function renderHistory() {
            const div = document.getElementById('history');
            let h = JSON.parse(localStorage.getItem('songs') || '[]');
            div.innerHTML = h.map(i => `<div class='glass p-4 rounded-xl flex justify-between items-center text-sm'><span>${i.t}</span><button onclick="setupPlayer('${i.u}', '${i.t}')" class='text-blue-500 font-bold'>Play</button></div>`).join('');
        }
        renderHistory();
    </script>
</body>
</html>
